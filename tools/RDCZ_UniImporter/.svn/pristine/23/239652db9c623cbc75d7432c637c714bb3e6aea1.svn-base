/* *****************************************************************************
 * To change this template, choose Tools | Templates
 * and open the template in the editor.
 */
package cz.incad.relief3.rdcz.uniimporter.model;

import cz.incad.commontools.utils.StringUtils;
import cz.incad.commontools.utils.XmlUtils;
import cz.incad.relief3.rdcz.uniimporter.model.enums.IssueStateEnum;
import java.io.BufferedInputStream;
import java.io.FileInputStream;
import java.io.IOException;
import java.io.StringWriter;
import java.util.LinkedList;
import java.util.List;
import java.util.logging.Level;
import java.util.logging.Logger;
import javax.xml.parsers.DocumentBuilder;
import javax.xml.parsers.DocumentBuilderFactory;
import javax.xml.parsers.ParserConfigurationException;
import javax.xml.transform.*;
import javax.xml.transform.dom.DOMSource;
import javax.xml.transform.stream.StreamResult;
import org.w3c.dom.*;
import org.xml.sax.SAXException;

/** ****************************************************************************
 *
 * @author martin
 */
public class DataParserMarcXml implements DataParser {
    private static final Logger LOG = Logger.getLogger(DataParserMarcXml.class.getName());

    /** ************************************************************************
     * 
     * @param oneIssue
     * @return 
     */
    public OneIssue parseIt(OneIssue oneIssue) {
        LOG.log(Level.INFO, "Start Parsing...");
        List<OneRecord> lRecords = new LinkedList<OneRecord>();
        OneRecord oneRecord;
        Document doc;
        NodeList nlRecord;
        NodeList nlRecordChilds;
        NodeList nl245;
        NodeList nl246;
        NodeList nl100;
        NodeList nl260;
        NodeList nl490;
        NodeList nl910;
        NodeList nl300;
        NodeList nl015;
        NodeList nl020;
        NodeList nl022;
        NodeList nl856;
        NodeList nl911;
        NodeList nlITM;
        Node nRecord;

        //Bibliograficke udaje
        String druhDokumentu;
        List<String> cisloCNB;
        String identifikatorZaznamu;
        String sysno;
        String autor;
        String nazev;
        String rokyVydani;
        List<String> isbn;
        List<String> issn;
        List<String> variantniNazvy;
        String siglaVlastnika;
        String urlNaTitul856;
        String urlNaTitul911;
        String mistoVydani;
        String vydavatel;
        String pocetStran;
        String vyskaKnihy;
        String serieName;
        String seriePart;
        //Exemplar
        //Udaje o digitalizaci
        String urlCastRokRocnik856;
        String urlCastRokRocnik911;
        List<OneITM> items              = new LinkedList<OneITM>();
        String nazev_245a;
        String nazev_245b;
        String nazev_245n;
        String nazev_245p;
        String rawXML                   = null;


        DocumentBuilderFactory factory = DocumentBuilderFactory.newInstance();
        try {
            doc = factory.newDocumentBuilder().parse(new BufferedInputStream(new FileInputStream(oneIssue.getFile())));
        } catch (ParserConfigurationException ex) {
            LOG.log(Level.SEVERE, null, ex);
            oneIssue.appendLogFailInfo("Soubor nebyl importován. Nastala chyba při parsování souboru. Chyba: " + ex.getMessage());
            oneIssue.issueState = IssueStateEnum._9_readyForLog;
            return oneIssue;
        } catch (SAXException ex) {
            LOG.log(Level.SEVERE, null, ex);
            oneIssue.appendLogFailInfo("Soubor nebyl importován. Nastala chyba při parsování souboru. Chyba: " + ex.getMessage());
            oneIssue.issueState = IssueStateEnum._9_readyForLog;
            return oneIssue;
        } catch (IOException ex) {
            LOG.log(Level.SEVERE, null, ex);
            oneIssue.appendLogFailInfo("");
            oneIssue.appendLogFailInfo("Soubor nebyl importován. Nastala chyba při načtení souboru. Chyba: " + ex.getMessage());
            oneIssue.issueState = IssueStateEnum._9_readyForLog;
            return oneIssue;
        }

        //Načteme všechny záznamy Record
        nlRecord = doc.getElementsByTagName("record");
        for (int i = 0; i < nlRecord.getLength(); i++) {
            //Zpracováváme jeden záznam za druhým.
            nl245 = null;
            nl246 = null;
            nl100 = null;
            nl260 = null;
            nl490 = null;
            nl910 = null;
            nl300 = null;
            nl015 = null;
            nl020 = null;
            nl022 = null;
            nl856 = null;
            nl911 = null;
            nlITM = null;
            //Vynulovani hodnot
            //Bibliograficke udaje
            druhDokumentu           = null;
            cisloCNB                = null;
            identifikatorZaznamu    = null;
            sysno                   = null;
            autor                   = null;
            nazev                   = null;
            rokyVydani              = null;
            isbn                    = null;
            issn                    = null;
            variantniNazvy          = null;
            siglaVlastnika          = null;
            urlNaTitul856              = null;
            urlNaTitul911             = null;
            mistoVydani             = null;
            vydavatel               = null;
            pocetStran              = null;
            vyskaKnihy              = null;
            serieName               = null;
            seriePart               = null;
            //Exemplar
            //Udaje o digitalizaci
            urlCastRokRocnik856        = null;
            urlCastRokRocnik911        = null;
            items.clear();
            nazev_245a              = null;
            nazev_245b              = null;
            nazev_245n              = null;
            nazev_245p              = null;
            rawXML                  = null;

            nRecord = nlRecord.item(i);
            //uložíme XML
            rawXML = "<?xml version=\"1.0\" encoding=\"utf-8\"?>" + getOneRecordXml(nRecord);
            nlRecordChilds = nRecord.getChildNodes();
            for (int j = 0; j < nlRecordChilds.getLength(); j++) {
                //Procházíme jeden prvek Recordu za druhým.
                //Odfiltrujeme jen zajímavé elementy
                if (nlRecordChilds.item(j).getNodeType() == 1) {
                    //DRUH DOKUMENTU
                    if ("FMT".equals(XmlUtils.getAttributValue(nlRecordChilds.item(j), "tag"))) {
                        druhDokumentu = nlRecordChilds.item(j).getTextContent();
                    }
                    //POLE 001
                    if ("001".equals(XmlUtils.getAttributValue(nlRecordChilds.item(j), "tag"))) {
                        identifikatorZaznamu = nlRecordChilds.item(j).getTextContent();
                    }
                    //SYSNO
                    if ("SYS".equals(XmlUtils.getAttributValue(nlRecordChilds.item(j), "tag"))) {
                        sysno = nlRecordChilds.item(j).getTextContent();
                    }
                    //245abn název podnázev
                    if ("245".equals(XmlUtils.getAttributValue(nlRecordChilds.item(j), "tag")) && nl245 == null) {
                        nl245 = nlRecordChilds.item(j).getChildNodes();
                        for (int k = 0; k < nl245.getLength(); k++) {
                            //Odfiltrujeme jen zajímavé elementy
                            if (nl245.item(k).getNodeType() == 1) {
                                if ("a".equals(XmlUtils.getAttributValue(nl245.item(k), "code"))) {
                                    nazev_245a = clear_245a(nl245.item(k).getTextContent());
                                }
                                if ("b".equals(XmlUtils.getAttributValue(nl245.item(k), "code"))) {
                                    nazev_245b = clear_245b(nl245.item(k).getTextContent());
                                }
                                if ("n".equals(XmlUtils.getAttributValue(nl245.item(k), "code"))) {
                                    nazev_245n = clear_245n(nl245.item(k).getTextContent());
                                }
                                if ("p".equals(XmlUtils.getAttributValue(nl245.item(k), "code"))) {
                                    nazev_245p = clear_245p(nl245.item(k).getTextContent());
                                }
                            }
                        }
                    }
                    //variantní názvy 246a
                    if ("246".equals(XmlUtils.getAttributValue(nlRecordChilds.item(j), "tag"))) {
                        nl246 = nlRecordChilds.item(j).getChildNodes();
                        for (int k = 0; k < nl246.getLength(); k++) {
                            //Odfiltrujeme jen zajímavé elementy
                            if (nl246.item(k).getNodeType() == 1) {
                                if ("a".equals(XmlUtils.getAttributValue(nl246.item(k), "code"))) {
                                    if (variantniNazvy == null) {
                                        variantniNazvy = new LinkedList<String>();
                                    }
                                    variantniNazvy.add(nl246.item(k).getTextContent());
                                }
                            }
                        }
                    }
                    //Autoři 100a
                    if ("100".equals(XmlUtils.getAttributValue(nlRecordChilds.item(j), "tag")) && nl100 == null) {
                        nl100 = nlRecordChilds.item(j).getChildNodes();
                        for (int k = 0; k < nl100.getLength(); k++) {
                            //Odfiltrujeme jen zajímavé elementy
                            if (nl100.item(k).getNodeType() == 1) {
                                if ("a".equals(XmlUtils.getAttributValue(nl100.item(k), "code"))) {
                                    autor = clear_100a(nl100.item(k).getTextContent());
                                }
                            }
                        }
                    }
                    //Vydavatelské údaje abc
                    if ("260".equals(XmlUtils.getAttributValue(nlRecordChilds.item(j), "tag")) && nl260 == null) {
                        nl260 = nlRecordChilds.item(j).getChildNodes();
                        for (int k = 0; k < nl260.getLength(); k++) {
                            //Odfiltrujeme jen zajímavé elementy
                            if (nl260.item(k).getNodeType() == 1) {
                                //místo vydání
                                if ("a".equals(XmlUtils.getAttributValue(nl260.item(k), "code"))) {
                                    mistoVydani = clear_260a(nl260.item(k).getTextContent());
                                }
                                //Vydavatel
                                if ("b".equals(XmlUtils.getAttributValue(nl260.item(k), "code"))) {
                                    vydavatel = clear_260b(nl260.item(k).getTextContent());
                                }
                                //Rok vydání
                                if ("c".equals(XmlUtils.getAttributValue(nl260.item(k), "code"))) {
                                    rokyVydani = clear_260c(nl260.item(k).getTextContent());
                                }
                            }
                        }
                    }
                    //Edice 490 a,v
                    if ("490".equals(XmlUtils.getAttributValue(nlRecordChilds.item(j), "tag")) && nl490 == null) {
                        nl490 = nlRecordChilds.item(j).getChildNodes();
                        for (int k = 0; k < nl490.getLength(); k++) {
                            //Odfiltrujeme jen zajímavé elementy
                            if (nl490.item(k).getNodeType() == 1) {
                                //seriename
                                if ("a".equals(XmlUtils.getAttributValue(nl490.item(k), "code"))) {
                                    serieName = nl490.item(k).getTextContent();
                                }
                                //seriepart
                                if ("v".equals(XmlUtils.getAttributValue(nl490.item(k), "code"))) {
                                    seriePart = nl490.item(k).getTextContent();
                                }
                            }
                        }
                    }
                    //SIGLA ind='1' a
                    if ("910".equals(XmlUtils.getAttributValue(nlRecordChilds.item(j), "tag")) && nl910 == null) {
                        nl910 = nlRecordChilds.item(j).getChildNodes();
                        for (int k = 0; k < nl910.getLength(); k++) {
                            //Odfiltrujeme jen zajímavé elementy
                            if (nl910.item(k).getNodeType() == 1) {
                                if ("a".equals(XmlUtils.getAttributValue(nl910.item(k), "code"))) {
                                    siglaVlastnika = nl910.item(k).getTextContent();
                                }
                            }
                        }
                    }
                    //počet stran výška knihy 300ac
                    if ("300".equals(XmlUtils.getAttributValue(nlRecordChilds.item(j), "tag")) && nl300 == null) {
                        nl300 = nlRecordChilds.item(j).getChildNodes();
                        for (int k = 0; k < nl300.getLength(); k++) {
                            //Odfiltrujeme jen zajímavé elementy
                            if (nl300.item(k).getNodeType() == 1) {
                                //Počet stran
                                if ("a".equals(XmlUtils.getAttributValue(nl300.item(k), "code"))) {
                                    pocetStran = nl300.item(k).getTextContent();
                                }
                                //Výška knihy
                                if ("c".equals(XmlUtils.getAttributValue(nl300.item(k), "code"))) {
                                    vyskaKnihy = nl300.item(k).getTextContent();
                                }
                            }
                        }
                    }
                    //čČNB 015a
                    if ("015".equals(XmlUtils.getAttributValue(nlRecordChilds.item(j), "tag")) && nl015 == null) {
                        nl015 = nlRecordChilds.item(j).getChildNodes();
                        for (int k = 0; k < nl015.getLength(); k++) {
                            //Odfiltrujeme jen zajímavé elementy
                            if (nl015.item(k).getNodeType() == 1) {
                                //Platné čČNB
                                if ("a".equals(XmlUtils.getAttributValue(nl015.item(k), "code"))) {
                                    if (cisloCNB == null) {
                                        cisloCNB = new LinkedList<String>();
                                    }
                                    cisloCNB.add(nl015.item(k).getTextContent());
                                }

                                //Neplatné čČNB
                                if ("z".equals(XmlUtils.getAttributValue(nl015.item(k), "code"))) {
                                    if (cisloCNB == null) {
                                        cisloCNB = new LinkedList<String>();
                                    }
                                    cisloCNB.add(nl015.item(k).getTextContent());
                                }
                            }
                        }
                    }
                    //ISBN 020az
                    if ("020".equals(XmlUtils.getAttributValue(nlRecordChilds.item(j), "tag"))) {
                        nl020 = nlRecordChilds.item(j).getChildNodes();
                        for (int k = 0; k < nl020.getLength(); k++) {
                            //Odfiltrujeme jen zajímavé elementy
                            if (nl020.item(k).getNodeType() == 1) {
                                //Platné ISBN
                                if ("a".equals(XmlUtils.getAttributValue(nl020.item(k), "code"))) {
                                    if (nl020.item(k).getTextContent() != null) {
                                        if (nl020.item(k).getTextContent().length() > 0) {
                                            if (StringUtils.canBeStringInteger(nl020.item(k).getTextContent().substring(0, 1))) {
                                                if (isbn == null) {
                                                    isbn = new LinkedList<String>();
                                                }
                                                isbn.add(trim020(nl020.item(k).getTextContent()));
                                            }
                                        }
                                    }
                                }

                                //Neplatné ISBN
                                if ("z".equals(XmlUtils.getAttributValue(nl020.item(k), "code"))) {
                                    if (nl020.item(k).getTextContent() != null) {
                                        if (nl020.item(k).getTextContent().length() > 0) {
                                            if (StringUtils.canBeStringInteger(nl020.item(k).getTextContent().substring(0, 1))) {
                                                if (isbn == null) {
                                                    isbn = new LinkedList<String>();
                                                }
                                                isbn.add(trim020(nl020.item(k).getTextContent()));
                                            }
                                        }
                                    }
                                }

                                //Neplatné ISBN
                                if ("y".equals(XmlUtils.getAttributValue(nl020.item(k), "code"))) {
                                    if (nl020.item(k).getTextContent() != null) {
                                        if (nl020.item(k).getTextContent().length() > 0) {
                                            if (StringUtils.canBeStringInteger(nl020.item(k).getTextContent().substring(0, 1))) {
                                                if (isbn == null) {
                                                    isbn = new LinkedList<String>();
                                                }
                                                isbn.add(trim020(nl020.item(k).getTextContent()));
                                            }
                                        }
                                    }
                                }
                            }
                        }
                    }
                    //ISSN 022az
                    if ("022".equals(XmlUtils.getAttributValue(nlRecordChilds.item(j), "tag"))) {
                        nl022 = nlRecordChilds.item(j).getChildNodes();
                        for (int k = 0; k < nl022.getLength(); k++) {
                            //Odfiltrujeme jen zajímavé elementy
                            if (nl022.item(k).getNodeType() == 1) {
                                //Platné ISSN
                                if ("a".equals(XmlUtils.getAttributValue(nl022.item(k), "code"))) {
                                    if (issn == null) {
                                        issn = new LinkedList<String>();
                                    }
                                    issn.add(nl022.item(k).getTextContent());
                                }

                                //Neplatné ISSN
                                if ("z".equals(XmlUtils.getAttributValue(nl022.item(k), "code"))) {
                                    if (issn == null) {
                                        issn = new LinkedList<String>();
                                    }
                                    issn.add(nl022.item(k).getTextContent());
                                }
                                
                                //Neplatné ISSN
                                if ("y".equals(XmlUtils.getAttributValue(nl022.item(k), "code"))) {
                                    if (issn == null) {
                                        issn = new LinkedList<String>();
                                    }
                                    issn.add(nl022.item(k).getTextContent());
                                }
                            }
                        }
                    }
                    //URL 856u
                    if ("856".equals(XmlUtils.getAttributValue(nlRecordChilds.item(j), "tag")) && nl856 == null) {
                        nl856 = nlRecordChilds.item(j).getChildNodes();
                        for (int k = 0; k < nl856.getLength(); k++) {
                            //Odfiltrujeme jen zajímavé elementy
                            if (nl856.item(k).getNodeType() == 1) {
                                //URL TITUL
                                if ("u".equals(XmlUtils.getAttributValue(nl856.item(k), "code"))) {
                                    if ("SE".equalsIgnoreCase(druhDokumentu)) {
                                        urlNaTitul856 = nl856.item(k).getTextContent();
                                    } else {
                                        urlCastRokRocnik856 = nl856.item(k).getTextContent();
                                    }
                                }
                            }
                        }
                    }

                    //URL 911u
                    if ("911".equals(XmlUtils.getAttributValue(nlRecordChilds.item(j), "tag")) && nl911 == null) {
                        nl911 = nlRecordChilds.item(j).getChildNodes();
                        for (int k = 0; k < nl911.getLength(); k++) {
                            //Odfiltrujeme jen zajímavé elementy
                            if (nl911.item(k).getNodeType() == 1) {
                                //URL TITUL
                                if ("u".equals(XmlUtils.getAttributValue(nl911.item(k), "code"))) {
                                    if ("SE".equalsIgnoreCase(druhDokumentu)) {
                                        urlNaTitul911 = nl911.item(k).getTextContent();
                                    } else {
                                        urlCastRokRocnik911 = nl911.item(k).getTextContent();
                                    }
                                }
                            }
                        }
                    }

                    if ("ITM".equals(XmlUtils.getAttributValue(nlRecordChilds.item(j), "tag"))) {
                        OneITM oneItm = new OneITM();
                        
                        nlITM = nlRecordChilds.item(j).getChildNodes();
                        for (int k = 0; k < nlITM.getLength(); k++) {
                            //Odfiltrujeme jen zajímavé elementy
                            if (nlITM.item(k).getNodeType() == 1) {
                                //Čárový kód
                                if ("b".equals(XmlUtils.getAttributValue(nlITM.item(k), "code"))) {
                                    oneItm.b = nlITM.item(k).getTextContent();
                                }
                                //signatura
                                if ("c".equals(XmlUtils.getAttributValue(nlITM.item(k), "code"))) {
                                    oneItm.c = nlITM.item(k).getTextContent();
                                }
                                //poznamka
                                if ("d".equals(XmlUtils.getAttributValue(nlITM.item(k), "code"))) {
                                    oneItm.d = nlITM.item(k).getTextContent();
                                }
                                //svazek rocnik
                                if ("v".equals(XmlUtils.getAttributValue(nlITM.item(k), "code"))) {
                                    oneItm.v = nlITM.item(k).getTextContent();
                                }
                                //cislo
                                if ("i".equals(XmlUtils.getAttributValue(nlITM.item(k), "code"))) {
                                    oneItm.i = nlITM.item(k).getTextContent();
                                }
                                //Rok
                                if ("y".equals(XmlUtils.getAttributValue(nlITM.item(k), "code"))) {
                                    oneItm.y = nlITM.item(k).getTextContent();
                                }
                            }
                        }
                        //Připojíme oneItem do pole všech itemů
                        items.add(oneItm);
                    }
                }
            }

            //Malej podvůdek, když přijde záznam bez exempláře,
            //tak musime vytvořit nafakeovaný exemplář bez hodnot aby se předloha vůbec založila
            if (items.isEmpty()) {
                items.add(new OneITM());
            }

            //Rozparzovaný záznam přidáme do listu
            for (int itemCount = 0; itemCount < items.size(); itemCount++) {
                //Vytvožíme si nový záznam
                oneRecord = new OneRecord();
                //Nastavíme záznamu rozparzované hodnoty
                oneRecord.setDruhDokumentu(druhDokumentu);
                oneRecord.setIdentifikatorZaznamu(identifikatorZaznamu);
                oneRecord.setSysno(sysno);

                nazev = null;
                if (nazev_245a != null) {
                    nazev = nazev_245a;
                }
                if (nazev_245n != null) {
                    if (nazev == null) {
                        nazev = nazev_245n;
                    } else {
                        nazev += " " + nazev_245n;
                    }
                }
                if (nazev_245p != null) {
                    if (nazev == null) {
                        nazev = nazev_245p;
                    } else {
                        nazev += " " + nazev_245p;
                    }
                }
                oneRecord.setRawXML(rawXML);
                oneRecord.setNazev(nazev);
                oneRecord.setPodnazev(nazev_245b);
                oneRecord.setAutor(autor);
                oneRecord.setMistoVydani(mistoVydani);
                oneRecord.setVydavatel(vydavatel);
                oneRecord.setRokyVydani(rokyVydani);
                oneRecord.setSiglaVlastnika(siglaVlastnika);
                oneRecord.setPocetStran(pocetStran);
                oneRecord.setVyskaKnihy(vyskaKnihy);
                oneRecord.setCisloCNB(cisloCNB);
                oneRecord.setIsbn(isbn);
                oneRecord.setIssn(issn);
                oneRecord.setVariantniNazev(variantniNazvy);
                oneRecord.setUrlNaTitul856(urlNaTitul856);
                oneRecord.setUrlNaTitul911(urlNaTitul911);
                oneRecord.setUrlCastRokRocnik856(urlCastRokRocnik856);
                oneRecord.setUrlCastRokRocnik911(urlCastRokRocnik911);
                oneRecord.setCarovyKod(items.get(itemCount).b);
                oneRecord.setSignatura(items.get(itemCount).c);
                oneRecord.setPoznamkaExemplar(items.get(itemCount).d);
                oneRecord.setCastDilRocnik(items.get(itemCount).v);
                oneRecord.setCisloPeriodika(items.get(itemCount).i);
                oneRecord.setRokPeriodika(items.get(itemCount).y);
                oneRecord.setSerieName(serieName);
                oneRecord.setSeriePart(seriePart);

                lRecords.add(oneRecord);
            }
        }

        oneIssue.lRecords = lRecords;
        LOG.log(Level.INFO, "Finish Parsing...");
        //Změna stavu issue
        oneIssue.issueState = IssueStateEnum._2_readyForImport;
        return oneIssue;
    }

    /** ************************************************************************
     * 
     * @param value
     * @return 
     */
    private static String clear_245a(String value) {
        if (value == null) {
            return null;
        }
        boolean isOk = false;
        while (!isOk) {
            isOk = true;
            value = value.trim();
            if (value.length() > 1 && (value.endsWith(":") || value.endsWith("/") || value.endsWith("="))) {
                value = value.substring(0, value.length() - 1);
                isOk = false;
            }
        }
        return value;
    }

    /** ************************************************************************
     * 
     * @param value
     * @return 
     */
    private static String clear_245b(String value) {
        if (value == null) {
            return null;
        }
        boolean isOk = false;
        while (!isOk) {
            isOk = true;
            value = value.trim();
            if (value.length() > 1 && (value.endsWith("/"))) {
                value = value.substring(0, value.length() - 1);
                isOk = false;
            }
        }
        return value;
    }

    /** ************************************************************************
     * 
     * @param value
     * @return 
     */
    private static String clear_245n(String value) {
        if (value == null) {
            return null;
        }
        boolean isOk = false;
        while (!isOk) {
            isOk = true;
            value = value.trim();
            if (value.length() > 1 && (value.endsWith(":") || value.endsWith("/") || value.endsWith("="))) {
                value = value.substring(0, value.length() - 1);
                isOk = false;
            }
        }
        return value;
    }

    /** ************************************************************************
     * 
     * @param value
     * @return 
     */
    private static String clear_245p(String value) {
        if (value == null) {
            return null;
        }
        boolean isOk = false;
        while (!isOk) {
            isOk = true;
            value = value.trim();
            if (value.length() > 1 && (value.endsWith(":") || value.endsWith("/") || value.endsWith("="))) {
                value = value.substring(0, value.length() - 1);
                isOk = false;
            }
        }
        return value;
    }
    
    /** ************************************************************************
     * 
     * @param value
     * @return 
     */
    private static String clear_260a(String value) {
        if (value == null) {
            return null;
        }
        boolean isOk = false;
        while (!isOk) {
            isOk = true;
            value = value.trim();
            if (value.length() > 1 && (value.endsWith(";") || value.endsWith(":") || value.endsWith(","))) {
                value = value.substring(0, value.length() - 1);
                isOk = false;
            }
        }
        return value;
    }

    /** ************************************************************************
     * 
     * @param value
     * @return 
     */
    private static String clear_260b(String value) {
        if (value == null) {
            return null;
        }
        boolean isOk = false;
        while (!isOk) {
            isOk = true;
            value = value.trim();
            if (value.length() > 1 && (value.endsWith(","))) {
                value = value.substring(0, value.length() - 1);
                isOk = false;
            }
        }
        return value;
    }

    /** ************************************************************************
     * 
     * @param value
     * @return 
     */
    private static String clear_100a(String value) {
        if (value == null) {
            return null;
        }
        boolean isOk = false;
        while (!isOk) {
            isOk = true;
            value = value.trim();
            if (value.length() > 1 && (value.endsWith(","))) {
                value = value.substring(0, value.length() - 1);
                isOk = false;
            }
        }
        return value;
    }

    /** ************************************************************************
     * 
     * @param value
     * @return 
     */
    private static String clear_260c(String value) {
        if (value == null) {
            return null;
        }
        StringBuilder sb = new StringBuilder(value);
        boolean isOk = false;
        while (!isOk) {
            isOk = true;
            if (sb.length() > 1 && (sb.indexOf("[") != -1)) {
                sb = sb.deleteCharAt(sb.indexOf("["));
                isOk = false;
            }
            if (sb.length() > 1 && (sb.indexOf("]") != -1)) {
                sb = sb.deleteCharAt(sb.indexOf("]"));
                isOk = false;
            }
        }

        return sb.toString().trim();
    }

    /** ************************************************************************
     * Ořízne příchozí řetězec o " ("
     * @param value
     * @return 
     */
    private static String trim020(String value) {
        String trimmer = " (";
        if (value == null) {
            return value;
        }
        if (value.contains(trimmer)) {
            return value.substring(0, value.indexOf(trimmer));
        }
        return value;
    }

    /** ************************************************************************
     *
     * @param sourceNode
     * @return
     */
    private static String getOneRecordXml(Node sourceNode) {
        DocumentBuilder dBuilder = null;
        DocumentBuilderFactory dBuilderF;
        Document oneItemXML;
        Element root;
        Node targetNode;
        StringWriter sw;
        StreamResult result;
        DOMSource source;
        
        dBuilderF = DocumentBuilderFactory.newInstance();
        try {
            dBuilder = dBuilderF.newDocumentBuilder();
            oneItemXML = dBuilder.newDocument();
            root = oneItemXML.createElement("collection");
            oneItemXML.appendChild(root);
            targetNode = oneItemXML.getFirstChild();
            importNode(targetNode, sourceNode); //Switcher

            //set up a transformer
            TransformerFactory transfac = TransformerFactory.newInstance();
            Transformer trans = transfac.newTransformer();
            trans.setOutputProperty(OutputKeys.OMIT_XML_DECLARATION, "yes");
            trans.setOutputProperty(OutputKeys.INDENT, "yes");

            //create string from xml tree
            sw = new StringWriter();
            result = new StreamResult(sw);
            source = new DOMSource(oneItemXML);

            trans.transform(source, result);
            String xmlString = sw.toString();
            return xmlString;
        } catch (ParserConfigurationException ex) {
            Logger.getLogger(DataParserMarcXml.class.getName()).log(Level.SEVERE, null, ex);
            return "";
        } catch (TransformerConfigurationException ex) {
            Logger.getLogger(DataParserMarcXml.class.getName()).log(Level.SEVERE, null, ex);
            return "";
        } catch (TransformerException ex) {
            Logger.getLogger(DataParserMarcXml.class.getName()).log(Level.SEVERE, null, ex);
            return "";
        }
    }

    /** ************************************************************************
      * Simple tree walker that will clone recursively a node. This is to
      * avoid using parser-specific API such as Sun's <tt>changeNodeOwner</tt>
      * when we are dealing with DOM L1 implementations since <tt>cloneNode(boolean)</tt>
      * will not change the owner document.
      * <tt>changeNodeOwner</tt> is much faster and avoid the costly cloning process.
      * <tt>importNode</tt> is in the DOM L2 interface.
      * @param   parent  the node parent to which we should do the import to.
      * @param   child   the node to clone recursively. Its clone will be
      *              appended to <tt>parent</tt>.
      * @return  the cloned node that is appended to <tt>parent</tt>
      */
     public static Node importNode(Node parent, Node child) {
         Node copy = null;
         final Document doc = parent.getOwnerDocument();
 
         switch (child.getNodeType()) {
         case Node.CDATA_SECTION_NODE:
             copy = doc.createCDATASection(((CDATASection) child).getData());
             break;
         case Node.COMMENT_NODE:
             copy = doc.createComment(((Comment) child).getData());
             break;
         case Node.DOCUMENT_FRAGMENT_NODE:
             copy = doc.createDocumentFragment();
             break;
         case Node.ELEMENT_NODE:
             final Element elem = doc.createElement(((Element) child).getTagName());
             copy = elem;
             final NamedNodeMap attributes = child.getAttributes();
             if (attributes != null) {
                 final int size = attributes.getLength();
                 for (int i = 0; i < size; i++) {
                     final Attr attr = (Attr) attributes.item(i);
                     elem.setAttribute(attr.getName(), attr.getValue());
                 }
             }
             break;
         case Node.ENTITY_REFERENCE_NODE:
             copy = doc.createEntityReference(child.getNodeName());
             break;
         case Node.PROCESSING_INSTRUCTION_NODE:
             final ProcessingInstruction pi = (ProcessingInstruction) child;
             copy = doc.createProcessingInstruction(pi.getTarget(), pi.getData());
             break;
         case Node.TEXT_NODE:
             copy = doc.createTextNode(((Text) child).getData());
             break;
         default:
             // this should never happen
             throw new IllegalStateException("Invalid node type: " + child.getNodeType());
         }

         // okay we have a copy of the child, now the child becomes the parent
         // and we are iterating recursively over its children.
         try {
             final NodeList children = child.getChildNodes();
             if (children != null) {
                 final int size = children.getLength();
                 for (int i = 0; i < size; i++) {
                     final Node newChild = children.item(i);
                     if (newChild != null) {
                         importNode(copy, newChild);
                     }
                 }
             }
         } catch (DOMException ignored) {

         }
         
         // bingo append it. (this should normally not be done here)
         parent.appendChild(copy);
         return copy;
     }

}

/** ****************************************************************************
 * 
 * @author martin.novacek@incad.cz
 */
class OneITM {
    /** Čárový kód */
    public String b = null;
    /** Signatura */
    public String c = null;
    /** Poznámka */
    public String d = null;
    /** Svazek / ročník */
    public String v = null;
    /** Číslo */
    public String i = null;
    /** Rok */
    public String y = null;
}
